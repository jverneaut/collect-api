generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Domain {
  id           String         @id @default(cuid())
  host         String         @unique
  canonicalUrl String
  displayName  String?
  isPublished  Boolean        @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  urls    Url[]
  profile DomainProfile?
  crawlRuns CrawlRun[]
}

model DomainProfile {
  domainId String @id
  domain   Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  sourceCrawlId String?

  name             String?
  description      String?
  primaryColorsJson String?
  styleTagsJson     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CrawlRun {
  id       String @id @default(cuid())
  domainId String
  domain   Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  status    String @default("PENDING")
  reviewStatus String @default("PENDING_REVIEW")
  reviewedAt DateTime?
  isPublished Boolean @default(false)
  publishedAt DateTime?
  tagsJson   String?
  jobId     String?
  startedAt DateTime?
  finishedAt DateTime?
  error      String?
  optionsJson String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crawls UrlCrawl[]

  @@index([domainId, createdAt])
  @@index([status, createdAt])
  @@index([reviewStatus, createdAt])
  @@index([isPublished, publishedAt])
}

model Url {
  id            String  @id @default(cuid())
  domainId      String
  domain        Domain  @relation(fields: [domainId], references: [id], onDelete: Cascade)
  path          String
  normalizedUrl String  @unique
  type          String @default("OTHER")
  isCanonical   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crawls UrlCrawl[]

  @@unique([domainId, path])
  @@index([domainId, type])
}

model UrlCrawl {
  id     String @id @default(cuid())
  urlId  String
  url    Url    @relation(fields: [urlId], references: [id], onDelete: Cascade)
  crawlRunId String?
  crawlRun   CrawlRun? @relation(fields: [crawlRunId], references: [id], onDelete: SetNull)

  status    String @default("PENDING")
  isPublished Boolean @default(false)
  startedAt DateTime?
  finishedAt DateTime?
  crawledAt DateTime?

  httpStatus      Int?
  finalUrl        String?
  title           String?
  metaDescription String?
  language        String?
  contentHash     String?
  error           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  screenshots   Screenshot[]
  sections      SectionScreenshot[]
  tasks         CrawlTask[]
  categories    CrawlCategory[]
  technologies  CrawlTechnology[]

  @@unique([crawlRunId, urlId])
  @@index([urlId, createdAt])
  @@index([crawlRunId, createdAt])
  @@index([status, createdAt])
}

model CrawlTask {
  id      String       @id @default(cuid())
  crawlId String
  crawl   UrlCrawl     @relation(fields: [crawlId], references: [id], onDelete: Cascade)

  type   String
  status String @default("PENDING")

  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  startedAt     DateTime?
  finishedAt    DateTime?
  error         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([crawlId, type])
  @@index([status, type])
}

model Screenshot {
  id      String         @id @default(cuid())
  crawlId String
  crawl   UrlCrawl       @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  kind    String @default("FULL_PAGE")
  isPublished Boolean @default(false)

  width      Int?
  height     Int?
  format     String?
  storageKey String?
  publicUrl  String?
  prominentColor String?

  createdAt DateTime @default(now())

  @@index([crawlId])
}

model SectionScreenshot {
  id      String   @id @default(cuid())
  crawlId String
  crawl   UrlCrawl @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  index   Int
  isPublished Boolean @default(false)

  clipJson    String?
  elementJson String?

  format     String?
  storageKey String?
  publicUrl  String?

  createdAt DateTime @default(now())

  @@unique([crawlId, index])
  @@index([crawlId])
}

model Category {
  id          String  @id @default(cuid())
  slug        String  @unique
  name        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crawls CrawlCategory[]
}

model CrawlCategory {
  crawlId    String
  categoryId String

  crawl    UrlCrawl  @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  confidence Float?

  @@id([crawlId, categoryId])
  @@index([categoryId])
}

model Technology {
  id         String  @id @default(cuid())
  slug       String  @unique
  name       String
  websiteUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  crawls CrawlTechnology[]
}

model CrawlTechnology {
  crawlId      String
  technologyId String

  crawl      UrlCrawl    @relation(fields: [crawlId], references: [id], onDelete: Cascade)
  technology Technology @relation(fields: [technologyId], references: [id], onDelete: Cascade)

  confidence Float?

  @@id([crawlId, technologyId])
  @@index([technologyId])
}
